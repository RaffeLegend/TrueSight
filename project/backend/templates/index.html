<!DOCTYPE html>
<html lang="zh">
<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Image Detection Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366F1',
            success: '#16A34A',
            danger: '#DC2626',
            warning: '#F59E0B',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'fade-slow': 'fadeSlow 1s ease-out'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: 0, transform: 'scale(0.95)' },
              '100%': { opacity: 1, transform: 'scale(1)' }
            },
            fadeSlow: {
              '0%': { opacity: 0 },
              '100%': { opacity: 1 }
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui']
          }
        }
      }
    }
  </script>
  <style>
    .spinner {
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #6366F1; /* Primary color */
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 0.8s linear infinite;
      margin: 2rem auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gradient-to-tr from-indigo-200 via-purple-100 to-pink-200 min-h-screen flex items-center justify-center p-6 font-sans">

  <div class="bg-white/90 backdrop-blur-xl shadow-2xl rounded-3xl p-10 w-full max-w-7xl animate-fade-in">
    <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-800 mb-10">
      ğŸ§  AI Image Detection Tool
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
      
      <!-- å·¦è¾¹ï¼šä¸Šä¼ å’Œé¢„è§ˆ -->
      <div class="flex flex-col items-center">
        <div id="dropZone" class="w-full border-2 border-dashed border-primary rounded-2xl p-8 text-center text-gray-500 hover:bg-primary/10 transition cursor-pointer mb-6">
          <p class="text-lg">ğŸ“¤ Click or Drag an image here</p>
          <input id="imageInput" type="file" accept="image/*" class="hidden" />
        </div>

        <img id="preview" class="rounded-2xl mb-6 hidden w-full h-auto shadow-lg transition-opacity duration-500" />

        <button onclick="detectImage()" class="w-full bg-primary hover:bg-indigo-700 active:scale-95 text-white font-bold py-3 px-6 rounded-2xl shadow-md transition">
          ğŸ” Detect Image
        </button>
      </div>

      <!-- å³è¾¹ï¼šæ£€æµ‹ç»“æœ -->
      <div class="md:col-span-2 flex flex-col items-center">
        <div id="result" class="text-center text-xl font-semibold min-h-[3rem] p-6 w-full rounded-2xl bg-gradient-to-r from-purple-100 to-pink-100 shadow-inner"></div>

        <div id="segmentation" class="mt-8 text-center hidden w-full animate-fade-slow">
          <h2 class="text-2xl font-bold mb-4">ğŸ–¼ï¸ Segmentation Result</h2>
          <img id="segmentationImage" class="rounded-2xl shadow-lg inline-block max-w-full h-auto opacity-0 transition-opacity duration-700" />
        </div>
      </div>
    </div>
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const dropZone = document.getElementById('dropZone');
    const preview = document.getElementById('preview');
    const resultDiv = document.getElementById('result');
    const segmentationDiv = document.getElementById('segmentation');
    const segmentationImage = document.getElementById('segmentationImage');

    dropZone.addEventListener('click', () => imageInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('bg-primary/20');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('bg-primary/20');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('bg-primary/20');
      imageInput.files = e.dataTransfer.files;
      handleImagePreview();
    });

    imageInput.addEventListener('change', handleImagePreview);

    function handleImagePreview() {
      const file = imageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.classList.remove('hidden');
          preview.style.opacity = 1; // ç¡®ä¿æ–°å›¾æ·¡å…¥
          resultDiv.innerHTML = '';
          segmentationDiv.classList.add('hidden');
          segmentationImage.src = '';
          segmentationImage.style.opacity = 0;
          preview.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
        reader.readAsDataURL(file);
      }
    }

    async function detectImage() {
      const file = imageInput.files[0];
      if (!file) {
        resultDiv.innerHTML = '<span class="text-danger">â— Please upload an image first.</span>';
        return;
      }

      // Spinner Loading
      resultDiv.innerHTML = '<div class="spinner"></div>';

      // æ¸…ç©º segmentation
      segmentationDiv.classList.add('hidden');
      segmentationImage.src = '';
      segmentationImage.style.opacity = 0;

      try {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('/api/detect', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

        const data = await response.json();

        let resultHtml = '<div class="animate-fade-slow">';
        if (data.result === 'ai') {
          resultHtml += '<span class="text-danger text-2xl font-bold">ğŸ¤– This is an AI-generated image.</span>';
        } else if (data.result === 'real') {
          resultHtml += '<span class="text-success text-2xl font-bold">ğŸ“· This image is authentic.</span>';
        } else if (data.result === 'tampered') {
          resultHtml += '<span class="text-warning text-2xl font-bold">ğŸ› ï¸ This image has been tampered with.</span>';
        } else {
          resultHtml += '<span class="text-gray-600 text-2xl font-bold">â“ Detection Result: Unknown.</span>';
        }

        if (data.reason) {
          resultHtml += `<div class="mt-6 text-gray-700 text-base bg-gray-100 p-6 rounded-2xl shadow-inner">
                          <strong>Reason:</strong> ${data.reason}
                         </div>`;
        }
        resultHtml += '</div>';

        resultDiv.innerHTML = resultHtml;
        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

        if (data.segmentation) {
          segmentationImage.src = data.segmentation;
          segmentationDiv.classList.remove('hidden');
          segmentationImage.onload = () => {
            segmentationImage.style.opacity = 1; // Segmentationå›¾ fade-in
          };
        }

      } catch (error) {
        console.error(error);
        resultDiv.innerHTML = '<span class="text-danger">âŒ Detection failed. Please try again later.</span>';
      }
    }
  </script>
</body>
</html>